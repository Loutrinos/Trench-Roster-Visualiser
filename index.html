<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trench Crusade Visual Lists</title>
    <link href="https://fonts.cdnfonts.com/css/conduit-itc-medium" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js"></script>
    <style>
        body {
            font-family: 'Conduit ITC Medium', 'Times New Roman', Times, serif;
            background-color: #222;
            color: #fff;
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .intro {
            position: absolute;
            width: 200px;
            left: 20px;
            top: 20px;
            background-color: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 10px;

        }

        .intro a {
            color: lightgray;
        }
        .intro input { padding: 10px 0; display: block; width: 100%; overflow: hidden; }
        .intro #clearButton { background-color: darkorange; color: black; border: 1px solid orange; width: 100%; border-radius: 5px; padding: 5px 0; }
        .intro #minimise { position: absolute; right: -15px; width: 30px; height: 30px; border-radius: 50%; background-color: inherit; text-align: center; line-height: 2; top: -15px; cursor: pointer; }
        .intro.hide { width: 0; height: 0; }
        .intro.hide *:not(#minimise) { display: none; font-size:1px;}

        #print {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 30px;
            background-color: rgba(255,255,255,0.2);
            border-radius: 5px;
            border: 1px solid black;
            padding: 10px;
            cursor: pointer;
         }
        #datasheets-container {
            display: flex;
            width: 90%;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .datasheet {
            width: 600px;
            background: #333;
            padding: 20px;
            border: 2px solid #FFD700;
            box-shadow: 3px 3px 10px rgba(255, 215, 0, 0.5);
            margin-bottom: 20px;
            border-radius: 10px;
        }
        .title {
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            border-bottom: 2px solid #FFD700;
            padding-bottom: 5px;
            color: #FFD700;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            background: #444;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
        }

        .stats div {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
        }

        .section {
            margin-top: 15px;
            background: #444;
            padding: 10px;
            border-radius: 5px;
        }
        .section-title {
            font-weight: bold;
            border-bottom: 1px solid #FFD700;
            margin-bottom: 5px;
            font-size: 18px;
            color: #FFD700;
        }

        .section .divider { 
            border-left: 1px solid white;
            padding: 0 3px;
            margin-left: 3px;
        }
        .abilities, .equipment, .upgrades {
            list-style: none;
            padding: 0;
        }
        .abilities li, .equipment li, .upgrades li {
            background: #555;
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #FFD700;
            border-radius: 3px;
        }
        
        @media print {
            .page, .page-break { break-after: page; }
            body { font-size: 80%!important; color:black; }
            * { border-color: black!important; box-shadow: none!important; }
            .title, .section-title { color:black!important; }
            .section { padding: 0 10px; }
            .section .divider { border-color: black; }
            .intro, #print { display: none; }
            
        }
    </style>
</head>

<body>
    <div class="intro">
        <div id="minimise">&#x2715;</div>
        <label for="fileInput">Add your Trench Crusade Json file generated from here </label><a href="https://trenchcompendium.netlify.app/" target="_blank">Trench Crusade List builder</a>
        <input type="file" id="fileInput" accept="application/json">
        <button id="clearButton">Clear</button>
        
    </div>
    <button id="print">üñ®Ô∏è</button>
    <div id="datasheets-container"></div>

    <script id="datasheet-template" type="text/x-handlebars-template">
        {{#each members}}
        <div class="datasheet">
            <div class="title">{{Name}}</div>
            <div class="stats">
                <div>Cost: {{TotalCost}} Ducats</div>
                <div>Elite: {{#if Elite}}‚úÖ{{else}}‚ùå{{/if}}</div>
                <div>Reserve: {{#if Reserve}}‚úÖ{{else}}‚ùå{{/if}}</div>
            </div>
            <div class="section">
                <div class="section-title">Tags</div>
                <p>{{#each Model.Object.Tags}}{{tag_name}}, {{/each}}</p>
            </div>
            <div class="section">
                <div class="section-title">Stats</div>
                <p>Movement: {{Model.Object.Movement.[0]}} <span class="divider"></span> Ranged: {{Model.Object.Ranged.[0]}} <span class="divider"></span> Melee: {{Model.Object.Melee.[0]}} <span class="divider"></span> Armour: {{FinalArmour}} <span class="divider"></span> Base: {{Model.Object.Base.[0]}}</p>
            </div>
            <div class="section">
                <div class="section-title">Abilities</div>
                <ul class="abilities">
                    {{#each ProcessedAbilities}}
                        <li><strong>{{name}}</strong>: {{description}}</li>
                    {{/each}}
                </ul>
            </div>
            <div class="section">
                <div class="section-title">Equipment</div>
                <ul class="equipment">
                    {{#each Equipment}}<li>{{Object.Name}} ({{Cost}}) - {{#if Object.Description.[0].SubContent.[0]}} {{Object.Description.[0].SubContent.[0].Content}} {{else}} {{Object.Blurb}} {{/if}}</li>{{/each}}
                </ul>
            </div>
            <div class="section">
                <div class="section-title">Upgrades</div>
                <ul class="upgrades">
                    {{#if Upgrades.length}}
                        {{#each Upgrades}}<li>{{Name}}</li>{{/each}}
                    {{else}}
                        <li>None</li>
                    {{/if}}
                </ul>
            </div>
            <div class="section">
                <div class="section-title">Description</div>
                <p>{{Model.Object.Blurb.[0].Content}}</p>
            </div>
        </div>
        <div class="page-break"></div>
        {{/each}}
    </script>

    <script>
        const keywordMap = {
            "ab_tough": "Tough",
            "ab_demonichorror": "Demonic Horror",
            "ab_strong": "Strong",
            "ab_goeticpraetor": "Goetic Praetor",
            "ab_goetichellknight": "Goetic Hellknight",
            "ab_bloodmagic": "Blood Magic",
            "ab_hateful": "Hateful",
            "ab_torturer": "Torturer",
            "ab_lawofhell": "Law of Hell",
            "ab_shadowwalker": "Shadow Walker",
            "ab_lefthandpath": "Left Hand Path",
            "ab_oraclebeastcloak": "Oracle Beast Cloak"
        };

        const keywordDescriptions = {
            "ab_tough": "If a TOUGH model would be taken Out Of Action, it is knocked Down instead. After a TOUGH model has been knocked Down in this way once, it can be taken Out of Action as normal.",
            "ab_demonichorror": "Description for Demonic Horror goes here.",
            "ab_strong": "A model with this Keyword ignores the rules for weapons/armour/equipment with Keyword HEAVY, including not being limited to carrying only one HEAVY item.",
            "ab_goeticpraetor": "Description for Goetic Praetor goes here.",
            "ab_goetichellknight": "Description for Goetic Hellknight goes here.",
            "ab_bloodmagic": "Before rolling an injury caused by the Hell Knight‚Äôs melee or ranged attack, it can use this GOETIC(1) power to roll that injury with +1 DICE. When this power is used on an injury caused by a BLAST weapon, it applies to every injury caused by that attack ACTION.",
            "ab_hateful": "When a yoke fiend is Activated, if there is an enemy model without the Keyword BLACK GRAIL or DEMONIC within 12‚Äù that it can see, it must make a Charge against the closest enemy model without the Keyword BLACK GRAIL or DEMONIC as its first ACTION. If it begins its Activation Down and the above conditions are true, it must stand and then Charge, unless it cannot stand. If it begins its Activation in melee combat, it ignores this ability",
            "ab_torturer": "The yoke fiend can make melee attacks against friendly models within 1‚Äù that don‚Äôt have the Keyword DEMONIC. When doing so, they can only make a single attack.",
            "ab_lawofhell": "If a wretch manages to take any enemy ELITE model Out of Action or performs a Glorious Deed, it gains its freedom and is immediately removed from the battle ‚Äì and from your warband ‚Äì permanently. It does not count as casualty, but your warband‚Äôs total size for this battle is reduced by one for purposes of Morale.",
            "ab_shadowwalker": "Using GOETIC (1), the Hunter can retreat from melee combat without any of its opponents getting the chance to make attacks against it",
            "ab_lefthandpath": "Once per Activation, as part of any single movement that the Hunter takes during its Activation (Standard Move, Retreat, Charge, Dash etc.), it can use a GOETIC (1) power to walk the path between Hell and Creation. The Hunter must be touching a piece of terrain when it uses this power. When it does, it is immediately placed in contact with any other piece of terrain on the battlefield, including on top of or inside terrain, if legal positions exist. Its movement then continues as normal. All usual movement rules persist for this movement (moving into or out of Melee Combat, for example). The Hunter can do this multiple times during its chosen move, though it has to pay the BLOOD MARKER cost for each such jump between terrain pieces. If the Hunter uses this ability during a Charge, it does not need to take the most direct route possible toward its target, but it still selects its target as normal (i.e. it can see the target when declaring a Charge).",
            "ab_oraclebeastcloak": "Once per turn, the Hunter can use this GOETIC (3) after an injury is rolled against it to negate the result (and any other effects caused by the triggering event) entirely. Effects from the triggering event, such as BLAST weapons that originally targeted the Hunter, still affect other models as normal."
        };

        // Function to process abilities
        function processAbilities(abilities) {
            return abilities.map(ability => {
                const key = ability.Content.toLowerCase().replace(/\s+/g, '_');
                return {
                    name: keywordMap[key] || ability.Content,
                    description: keywordDescriptions[key] || "No description available."
                };
            });
        }

        document.getElementById("fileInput").addEventListener("change", function (event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = JSON.parse(e.target.result);
                const members = data.Members.map(member => {
                    const baseCost = member.Model.Cost || 0;
                    const equipmentCost = member.Equipment.reduce((sum, item) => sum + (item.Cost || 0), 0);
                    const totalCost = baseCost + equipmentCost;

                    let baseArmour = member.Model.Object.Armour[0] || 0;
                    const equipmentArmour = member.Equipment.reduce((sum, item) => sum + (item.Object.EventTags?.armour || 0), 0);
                    const finalArmour = baseArmour + equipmentArmour;

                    return {
                        ...member,
                        TotalCost: totalCost,
                        FinalArmour: finalArmour,
                        ProcessedAbilities: member.Model.Object.Abilities.map(ability => ({
                            name: keywordMap[ability.Content] || ability.Content,
                            description: keywordDescriptions[ability.Content] || "No description available."
                        }))
                    };
                });
                
                const templateSource = document.getElementById("datasheet-template").innerHTML;
                const template = Handlebars.compile(templateSource);
                const compiledHtml = template({ members });
                document.getElementById("datasheets-container").innerHTML = compiledHtml;
            };
            reader.readAsText(file);
        });

        document.getElementById("clearButton").addEventListener("click", function() {
            document.getElementById("datasheets-container").innerHTML = "";
            document.getElementById("fileInput").value = "";
        });

        document.getElementById("minimise").addEventListener("click", function() {
            document.getElementsByClassName("intro")[0].classList.toggle("hide");
        });

        document.getElementById("print").addEventListener("click", function() {
            window.print();
        });
    </script>
</body>

</html>